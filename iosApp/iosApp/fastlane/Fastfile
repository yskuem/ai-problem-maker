# fastlane/Fastfile
default_platform(:ios)

platform :ios do
  lane :release do
    # ------------------ バージョン／ビルド番号更新 ------------------
    current_version = get_version_number(
      xcodeproj: "iosApp.xcodeproj",
      target:    "iosApp"
    )
    current_build = get_build_number(
      xcodeproj: "iosApp.xcodeproj",
      target:    "iosApp"
    ).to_i

    # patch を +1
    increment_version_number(
      bump_type: "patch",
      xcodeproj: "iosApp.xcodeproj",
      target:    "iosApp"
    )
    new_version = get_version_number(
      xcodeproj: "iosApp.xcodeproj",
      target:    "iosApp"
    )

    # build を +1
    new_build = current_build + 1
    increment_build_number(
      build_number: new_build,
      xcodeproj:    "iosApp.xcodeproj",
      target:       "iosApp"
    )

    # ------------------ 証明書／ビルド／アップロード ------------------
    match(
      type: "appstore",
      api_key: app_store_connect_api_key(
        key_id:      ENV["ASC_KEY_ID"],
        issuer_id:   ENV["ASC_ISSUER_ID"],
        key_content: Base64.decode64(ENV["ASC_PRIVATE_KEY_BASE64"])
      )
    )

    build_app(
      scheme: "iosApp",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "app.yskuem.aimondaimaker" => "match AppStore app.yskuem.aimondaimaker"
        }
      }
    )

    upload_to_app_store(
      submit_for_review: true,
      automatic_release: true,
      api_key: app_store_connect_api_key(
        key_id:      ENV["ASC_KEY_ID"],
        issuer_id:   ENV["ASC_ISSUER_ID"],
        key_content: Base64.decode64(ENV["ASC_PRIVATE_KEY_BASE64"])
      )
    )

    # ------------------ 変更をコミット & タグ付け & プッシュ ------------------
    commit_version_bump(
      xcodeproj_path: "iosApp.xcodeproj",
      force:          true,
      message:        "chore: version bump to #{new_version} (#{new_build}) [skip ci]"
    )

    # Git タグを作成 (例: v1.2.4)
    add_git_tag(
      tag:   "v#{new_version}",
      force: true,
      message: "Release #{new_version}"
    )

    # 変更とタグをリモートへプッシュ
    push_to_git_remote(
      tags: true        # ← タグも同時にプッシュ
    )
  end
end
